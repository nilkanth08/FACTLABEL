<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Supplement Facts Label Generator ‚Äî Pro</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;background:#f4f6fb;min-height:100vh;padding:20px}
    .container{max-width:1400px;margin:0 auto}
    header{text-align:center;color:#222;margin-bottom:20px}
    header h1{font-size:1.9rem;margin-bottom:6px}
    .main{display:grid;grid-template-columns:1fr 1fr;gap:22px}
    @media (max-width: 968px){.main{grid-template-columns:1fr}}
    .panel{background:#fff;border-radius:12px;padding:18px;box-shadow:0 10px 28px rgba(0,0,0,.06)}
    .panel h2{font-size:1.15rem;margin-bottom:10px;border-bottom:2px solid #e8eaf6;padding-bottom:6px;color:#333}
    .panel h3{font-size:1rem;margin:14px 0 8px;color:#555}
    label{display:block;font-weight:600;margin-bottom:6px;color:#555}
    input[type=text],input[type=number],select,textarea{width:100%;padding:9px 11px;border:2px solid #e0e0e0;border-radius:8px;font-size:1rem}
    textarea{min-height:72px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn{background:#556cd6;color:#fff;border:none;padding:10px 16px;border-radius:10px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#f5f5f5;color:#333}
    .btn.small{padding:8px 12px;font-size:.9rem}
    .btn.danger{background:#ff4757}
    .list{max-height:360px;overflow:auto;margin-top:10px}
    .item{display:flex;justify-content:space-between;align-items:center;background:#f8f9fa;border-radius:8px;padding:10px;margin-bottom:8px}
    .item .name{font-weight:700;color:#333}
    .item .meta{font-size:.9rem;color:#666}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:8px}
    .chip{border:2px solid #556cd6;background:#fff;color:#556cd6;padding:8px;border-radius:8px;font-weight:700;text-align:center;cursor:pointer}
    .chip:hover{background:#556cd6;color:#fff}
    .tips{background:#e3f2fd;padding:10px;border-radius:8px;color:#1976d2;font-size:.95rem;margin:10px 0}
    /* Label */
    .label-wrap{display:flex;flex-direction:column;align-items:center;gap:10px}
    .supplement-label{border:3px solid #000;padding:10px;background:#fff;max-width:420px;margin:0 auto;font-family:Arial,Helvetica,sans-serif}
    .supplement-label .title{font-size:36px;font-weight:900;letter-spacing:-1px;border-bottom:12px solid #000;padding-bottom:4px;margin-bottom:6px}
    .supplement-label .serving{font-size:14px;line-height:1.35;padding:4px 0}
    .supplement-label .servings{font-size:14px;padding-bottom:4px;border-bottom:8px solid #000;margin-bottom:6px}
    .supplement-label .amount-header{display:flex;justify-content:space-between;font-weight:700;font-size:14px;padding:6px 0;border-bottom:4px solid #000;margin-bottom:4px}
    .supplement-label .row{display:flex;justify-content:space-between;align-items:flex-start;border-bottom:1px solid #000;padding:4px 0;font-size:14px;min-height:28px}
    .supplement-label .n{flex:1;padding-right:10px;line-height:1.3}
    .supplement-label .a{text-align:right;min-width:90px;padding:0 5px}
    .supplement-label .dv{text-align:right;min-width:60px}
    .supplement-label .blend-h{font-weight:700;margin-bottom:2px}
    .supplement-label .blend-i{font-size:12px;line-height:1.3;margin-top:2px}
    .supplement-label .foot{margin-top:8px;padding-top:8px;font-size:12px;line-height:1.3}
    .supplement-label .other{margin-top:10px;padding-top:10px;border-top:2px solid #000;font-size:13px;line-height:1.4}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px;align-items:flex-end}
    .mm-note{font-size:.95rem;color:#333;background:#fff;border:1px dashed #999;padding:8px 10px;border-radius:8px}
    .sizer-grid{display:grid;grid-template-columns:repeat(6, minmax(90px,1fr));gap:8px;width:100%}
    @media print{
      body{background:#fff}
      .hide-print{display:none}
      .supplement-label{-webkit-print-color-adjust:exact;print-color-adjust:exact;border:3px solid #000 !important}
    }
  </style>
  <!-- Export libs (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <h1>üß™ Supplement Facts Label Generator ‚Äî Pro</h1>
      <p>Create clean, FDA-style labels, export PNG/JPG/PDF, and see exact mm size of the outline box.</p>
    </header>

    <div class="main">
      <div class="panel">
        <h2>Product</h2>
        <div class="row">
          <div>
            <label>Serving Size *</label>
            <input id="servingSize" type="text" placeholder="e.g., 2 Capsules" />
          </div>
          <div>
            <label>Servings Per Container *</label>
            <input id="servingsPerContainer" type="number" min="1" placeholder="e.g., 30" />
          </div>
        </div>

        <h3>Quick Templates</h3>
        <div class="grid">
          <button class="chip" onclick="loadTemplate('probiotic')">Probiotic Complex</button>
          <button class="chip" onclick="loadTemplate('nad')">NAD+ Supplement</button>
          <button class="chip" onclick="loadTemplate('multivitamin')">Multivitamin</button>
          <button class="chip" onclick="loadTemplate('omega3')">Omega-3</button>
        </div>

        <h2>Add Ingredients</h2>
        <div class="tips">Use the DV field as a number (e.g., 100), or put <b>‚Ä†</b> for ‚ÄúDaily Value not established‚Äù.</div>

        <div>
          <label>Ingredient Type</label>
          <select id="ingredientType" onchange="toggleBlendInputs()">
            <option value="single">Single Ingredient</option>
            <option value="blend">Blend (Multiple)</option>
          </select>
        </div>

        <!-- Single -->
        <div id="singleIngredientInput">
          <label>Ingredient Name</label>
          <input id="ingredientName" type="text" placeholder="e.g., NAD (Nicotinamide Adenine Dinucleotide)"/>
          <div class="row" style="margin-top:8px">
            <input id="ingredientAmount" type="number" step="0.001" placeholder="Amount"/>
            <select id="ingredientUnit">
              <option value="mg">mg</option><option value="mcg">mcg</option><option value="g">g</option>
              <option value="IU">IU</option><option value="billion CFU">billion CFU</option><option value="million CFU">million CFU</option>
              <option value="PU">PU</option><option value="AU">AU</option><option value="GDU">GDU</option>
            </select>
          </div>
          <div class="row" style="margin-top:8px">
            <input id="ingredientDV" type="text" placeholder="% DV (e.g., 100) or ‚Ä†"/>
            <button class="btn small" onclick="addIngredient()">Add</button>
          </div>
        </div>

        <!-- Blend -->
        <div id="blendInput" style="display:none">
          <label>Blend Name</label>
          <input id="blendName" type="text" placeholder="e.g., 20 Billion CFU Probiotic Blend‚Ä†"/>
          <div class="row" style="margin-top:8px">
            <input id="blendAmount" type="number" step="0.001" placeholder="Total Amount"/>
            <select id="blendUnit">
              <option value="mg">mg</option><option value="mcg">mcg</option><option value="g">g</option>
            </select>
          </div>
          <div class="row" style="margin-top:8px">
            <input id="blendDV" type="text" placeholder="% DV (e.g., 100) or ‚Ä†"/>
            <input id="blendFootnote" type="text" placeholder="Optional footnote, e.g., ‚Ä†Formulated with 20 Billion CFU at manufacture."/>
          </div>
          <label style="margin-top:8px">Blend Ingredients (comma separated)</label>
          <textarea id="blendIngredients" placeholder="L. acidophilus, B. longum, L. reuteri" rows="3"></textarea>
          <div style="margin-top:8px">
            <button class="btn small" onclick="addBlend()">Add Blend</button>
          </div>
        </div>

        <h3 style="margin-top:16px">Quick Add</h3>
        <div class="grid">
          <button class="chip" onclick="quickAdd('Vitamin C',500,'mg','100')">Vitamin C</button>
          <button class="chip" onclick="quickAdd('Vitamin D',25,'mcg','125')">Vitamin D</button>
          <button class="chip" onclick="quickAdd('Zinc',15,'mg','136')">Zinc</button>
          <button class="chip" onclick="quickAdd('Omega-3',1000,'mg','‚Ä†')">Omega-3</button>
          <button class="chip" onclick="quickAdd('Probiotics',10,'billion CFU','‚Ä†')">Probiotics</button>
          <button class="chip" onclick="quickAdd('CoQ10',100,'mg','‚Ä†')">CoQ10</button>
        </div>

        <h3>Current Ingredients</h3>
        <div id="ingredientsList" class="list"><p style="color:#999;text-align:center">No ingredients yet</p></div>

        <div style="margin-top:12px">
          <label>Other Ingredients (Inactive)</label>
          <textarea id="otherIngredients" placeholder="Hypromellose (cellulose) capsule, magnesium stearate (vegetable source), silica." rows="3"></textarea>
        </div>
        <div style="margin-top:12px">
          <label>Additional Footnotes (Optional)</label>
          <textarea id="additionalFootnotes" placeholder="‚Ä† Daily Value (DV) not established." rows="2"></textarea>
        </div>

        <div class="actions hide-print" style="margin-top:16px;display:flex;flex-direction:column;gap:10px">
          <div class="sizer-grid">
            <div>
              <label>Width</label>
              <input id="outW" type="number" step="0.01" placeholder="e.g., 140">
            </div>
            <div>
              <label>Height</label>
              <input id="outH" type="number" step="0.01" placeholder="e.g., 60">
            </div>
            <div>
              <label>Units</label>
              <select id="outUnit">
                <option value="mm">mm</option>
                <option value="px">px</option>
                <option value="in">in</option>
              </select>
            </div>
            <div>
              <label>DPI (PNG/JPG)</label>
              <input id="outDPI" type="number" step="1" value="300">
            </div>
            <div style="display:flex;align-items:flex-end">
              <label style="display:flex;gap:8px;align-items:center">
                <input id="keepAR" type="checkbox" checked> Keep aspect
              </label>
            </div>
            <div style="display:flex;align-items:flex-end">
              <button class="btn small secondary" onclick="fillFromCurrent()">Use current mm</button>
            </div>
          </div>

          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn" onclick="window.print()">üñ®Ô∏è Print</button>
            <button class="btn" onclick="downloadImage('png')">‚¨áÔ∏è PNG</button>
            <button class="btn" onclick="downloadImage('jpg')">‚¨áÔ∏è JPG</button>
            <button class="btn" onclick="downloadPDF()">‚¨áÔ∏è PDF</button>
            <button class="btn secondary" onclick="copyHTML()">üìã Copy HTML</button>
            <button class="btn secondary" onclick="exportData()">üìä Export JSON</button>
            <button class="btn secondary" onclick="clearAll()">Clear</button>
          </div>
        </div>
      </div>

      <div class="panel">
        <h2>Label Preview</h2>
        <div class="label-wrap">
          <div id="labelPreview" class="supplement-label">
            <div class="title">Supplement Facts</div>
            <div class="serving">Serving Size: <span id="labelServingSize">Not specified</span></div>
            <div class="servings">Servings Per Container: <span id="labelServings">Not specified</span></div>
            <div class="amount-header"><div>Amount Per Serving</div><div>% DV</div></div>
            <div id="ingredientRows">
              <p style="text-align:center;padding:20px;color:#999;border-bottom:1px solid #000">Add ingredients to see them here</p>
            </div>
          </div>
          <div id="mmInfo" class="mm-note">Outline box size: ‚Äî √ó ‚Äî mm</div>
        </div>
        <div class="tips" style="margin-top:12px">The mm size uses browser CSS pixel conversion (96&nbsp;DPI ‚Üí 25.4&nbsp;mm/in).</div>
      </div>
    </div>
  </div>

  <script>
    // State
    let ingredients = [];
    let footnotes = [];

    function pxToMm(px){return px/96*25.4}
    function updateMmInfo(){
      const el = document.getElementById('labelPreview');
      const r = el.getBoundingClientRect();
      const w = pxToMm(r.width).toFixed(1);
      const h = pxToMm(r.height).toFixed(1);
      document.getElementById('mmInfo').textContent = `Outline box size: ${w} √ó ${h} mm`;
    }
    window.addEventListener('resize', updateMmInfo);

    function toggleBlendInputs(){
      const t=document.getElementById('ingredientType').value;
      document.getElementById('singleIngredientInput').style.display = t==='single'?'block':'none';
      document.getElementById('blendInput').style.display = t==='blend'?'block':'none';
    }

    function normalizeDV(input){
      const v = (input||'').trim();
      if(!v) return '‚Ä†';
      if(v === '**' || v.toLowerCase()==='na') return '‚Ä†';
      if(v === '‚Ä†') return '‚Ä†';
      const n = Number(v);
      return isFinite(n) && n>=0 ? String(n) : '‚Ä†';
    }

    function addIngredient(){
      const name = document.getElementById('ingredientName').value.trim();
      const amount = parseFloat(document.getElementById('ingredientAmount').value);
      const unit = document.getElementById('ingredientUnit').value;
      const dv = normalizeDV(document.getElementById('ingredientDV').value);
      if(name && amount){
        ingredients.push({id:Date.now(), type:'single', name, amount, unit, dv});
        document.getElementById('ingredientName').value='';
        document.getElementById('ingredientAmount').value='';
        document.getElementById('ingredientDV').value='';
        updateIngredientsList(); updateLabel();
      }else{ alert('Please enter ingredient name and amount'); }
    }

    function addBlend(){
      const name = document.getElementById('blendName').value.trim();
      const amount = parseFloat(document.getElementById('blendAmount').value);
      const unit = document.getElementById('blendUnit').value;
      const dv = normalizeDV(document.getElementById('blendDV').value);
      const blendIngredients = document.getElementById('blendIngredients').value.trim();
      const footnote = document.getElementById('blendFootnote').value.trim();
      if(name && amount && blendIngredients){
        const obj = {id:Date.now(), type:'blend', name, amount, unit, dv, ingredients:blendIngredients, footnote};
        ingredients.push(obj);
        if(footnote){ footnotes.push(footnote); }
        document.getElementById('blendName').value='';
        document.getElementById('blendAmount').value='';
        document.getElementById('blendDV').value='';
        document.getElementById('blendIngredients').value='';
        document.getElementById('blendFootnote').value='';
        updateIngredientsList(); updateLabel();
      }else{ alert('Please fill blend name, amount, and ingredients'); }
    }

    function quickAdd(name, amount, unit, dv){
      ingredients.push({id:Date.now(), type:'single', name, amount, unit, dv: normalizeDV(dv)});
      updateIngredientsList(); updateLabel();
    }

    function removeIngredient(id){
      const ing = ingredients.find(i=>i.id===id);
      if(ing && ing.footnote){ footnotes = footnotes.filter(f=>f!==ing.footnote); }
      ingredients = ingredients.filter(i=>i.id!==id);
      updateIngredientsList(); updateLabel();
    }

    function updateIngredientsList(){
      const list = document.getElementById('ingredientsList');
      if(ingredients.length===0){ list.innerHTML='<p style="color:#999;text-align:center">No ingredients yet</p>'; return; }
      list.innerHTML = ingredients.map(ing=>{
        let d = `${ing.amount} ${ing.unit}`;
        if(ing.dv){ d += ing.dv==='‚Ä†' ? ' ‚Ä¢ DV not established' : ` ‚Ä¢ ${ing.dv}% DV`; }
        if(ing.type==='blend'){ d += `<br><small style="color:#888">Contains: ${ing.ingredients}</small>`; }
        return `<div class="item">
          <div><div class="name">${ing.name}</div><div class="meta">${d}</div></div>
          <button class="btn small danger" onclick="removeIngredient(${ing.id})">Remove</button>
        </div>`;
      }).join('');
    }

    function updateLabel(){
      const servingSize = document.getElementById('servingSize').value || 'Not specified';
      const servings = document.getElementById('servingsPerContainer').value || 'Not specified';
      document.getElementById('labelServingSize').textContent = servingSize;
      document.getElementById('labelServings').textContent = servings;

      let html = '';
      let needsDv = false;
      ingredients.forEach(ing=>{
        if(ing.type==='single'){
          html += `<div class="row"><div class="n">${ing.name}</div><div class="a">${ing.amount}${ing.unit}</div><div class="dv">${ing.dv==='‚Ä†'?'‚Ä†':ing.dv+'%'}</div></div>`;
        }else{
          html += `<div class="row"><div class="n"><div class="blend-h">${ing.name}</div><div class="blend-i">${ing.ingredients}</div></div><div class="a">${ing.amount} ${ing.unit}</div><div class="dv">${ing.dv==='‚Ä†'?'‚Ä†':ing.dv+'%'}</div></div>`;
        }
        if(ing.dv==='‚Ä†'){ needsDv = true; }
      });

      const footBlock = [];
      ingredients.forEach(i=>{ if(i.footnote){ footBlock.push(i.footnote); } });
      if(needsDv){ footBlock.push('‚Ä† Daily Value (DV) not established.'); }
      const extra = (document.getElementById('additionalFootnotes').value||'').trim();
      if(extra){ footBlock.push(extra); }

      if(footBlock.length>0){ html += `<div class="foot">${footBlock.join('<br>')}</div>`; }

      const other = (document.getElementById('otherIngredients').value||'').trim();
      if(other){ html += `<div class="other"><strong>Other ingredients:</strong> ${other}</div>`; }

      const container = document.getElementById('ingredientRows');
      container.innerHTML = html || '<p style="text-align:center;padding:20px;color:#999;border-bottom:1px solid #000">Add ingredients to see them here</p>';
      requestAnimationFrame(updateMmInfo);
    }

    function clearAll(){
      if(!confirm('Clear all data?')) return;
      ingredients=[]; footnotes=[];
      ['servingSize','servingsPerContainer','ingredientName','ingredientAmount','ingredientDV','blendName','blendAmount','blendDV','blendIngredients','blendFootnote','otherIngredients','additionalFootnotes'].forEach(id=>{const el=document.getElementById(id); if(el) el.value='';});
      updateIngredientsList(); updateLabel();
    }

    function loadTemplate(type){
      ingredients=[]; footnotes=[];
      if(type==='probiotic'){
        document.getElementById('servingSize').value='1 Capsule';
        document.getElementById('servingsPerContainer').value='30';
        ingredients.push({id:Date.now(),type:'blend',name:'20 Billion CFU Probiotic Blend‚Ä†',amount:101,unit:'mg',dv:'‚Ä†',ingredients:'L. acidophilus, B. longum, L. reuteri, L. casei, L. rhamnosus, L. plantarum, B. lactis, L. bulgaricus, B. bifidum, L. paracasei',footnote:'‚Ä†Formulated with 20 Billion CFU at time of manufacture.'});
        setTimeout(()=>{
          ingredients.push({id:Date.now()+1,type:'blend',name:'Prebiotic Blend',amount:250,unit:'mg',dv:'‚Ä†',ingredients:'Inulin (Jerusalem Artichoke), Inulin (Blue Agave), Chicory Root, Banana Fruit, Apple Fruit'});
          ingredients.push({id:Date.now()+2,type:'blend',name:'Digestive Enzyme Blend',amount:150,unit:'mg',dv:'‚Ä†',ingredients:'Papain (30,000 PU), Actinidin (1,250 AU), Bromelain (3.5 GDU)'});
          footnotes=['‚Ä†Formulated with 20 Billion CFU at time of manufacture.'];
          document.getElementById('otherIngredients').value='Hypromellose (Delayed Release Capsule), Organic Rice Hulls.';
          updateIngredientsList(); updateLabel();
        },100);
      }else if(type==='nad'){
        document.getElementById('servingSize').value='2 Capsules';
        document.getElementById('servingsPerContainer').value='30';
        ingredients.push({id:Date.now(),type:'single',name:'NAD (Nicotinamide Adenine Dinucleotide)',amount:1000,unit:'mg',dv:'‚Ä†'});
        document.getElementById('otherIngredients').value='Hypromellose (cellulose) capsule, magnesium stearate (vegetable source), silica.';
        document.getElementById('additionalFootnotes').value='‚Ä† Daily Value (DV) not established.';
      }else if(type==='multivitamin'){
        document.getElementById('servingSize').value='2 Tablets';
        document.getElementById('servingsPerContainer').value='30';
        const vits=[
          ['Vitamin A',900,'mcg','100'],['Vitamin C',90,'mg','100'],['Vitamin D',25,'mcg','125'],['Vitamin E',15,'mg','100'],
          ['Thiamin',1.2,'mg','100'],['Riboflavin',1.3,'mg','100'],['Niacin',16,'mg','100'],['Vitamin B6',1.7,'mg','100'],
          ['Folate',400,'mcg DFE','100'],['Vitamin B12',2.4,'mcg','100'],['Biotin',30,'mcg','100'],['Pantothenic Acid',5,'mg','100']
        ];
        vits.forEach((v,i)=>setTimeout(()=>{ingredients.push({id:Date.now()+i,type:'single',name:v[0],amount:v[1],unit:v[2],dv:v[3]}); if(i===vits.length-1){document.getElementById('otherIngredients').value='Microcrystalline cellulose, croscarmellose sodium, magnesium stearate, silicon dioxide, coating (hypromellose, glycerin).'; updateIngredientsList(); updateLabel();}}, i*30));
      }else if(type==='omega3'){
        document.getElementById('servingSize').value='2 Softgels';
        document.getElementById('servingsPerContainer').value='30';
        ingredients.push({id:Date.now(),type:'single',name:'Fish Oil Concentrate',amount:2000,unit:'mg',dv:'‚Ä†'});
        setTimeout(()=>{
          ingredients.push({id:Date.now()+1,type:'single',name:'EPA (Eicosapentaenoic Acid)',amount:360,unit:'mg',dv:'‚Ä†'});
          ingredients.push({id:Date.now()+2,type:'single',name:'DHA (Docosahexaenoic Acid)',amount:240,unit:'mg',dv:'‚Ä†'});
          document.getElementById('otherIngredients').value='Gelatin, glycerin, purified water, natural lemon flavor.';
          updateIngredientsList(); updateLabel();
        },100);
      }
      updateIngredientsList(); updateLabel();
      alert(type.charAt(0).toUpperCase()+type.slice(1)+' template loaded!');
    }

    function exportData(){
      const data={servingSize:document.getElementById('servingSize').value,servingsPerContainer:document.getElementById('servingsPerContainer').value,ingredients,otherIngredients:document.getElementById('otherIngredients').value,footnotes,additionalFootnotes:document.getElementById('additionalFootnotes').value};
      const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='supplement-facts-data.json'; a.click();
      URL.revokeObjectURL(a.href);
    }

    function copyHTML(){
      const html=document.getElementById('labelPreview').outerHTML;
      navigator.clipboard.writeText(html).then(()=>alert('Label HTML copied!')).catch(()=>alert('Copy failed‚Äîselect and copy manually.'));
    }

    async function toCanvas(){
      if(typeof html2canvas === 'undefined'){
        alert('html2canvas not loaded. PNG/JPG/PDF exports require the CDN. Try hard-refresh or disable blockers.');
        throw new Error('html2canvas missing');
      }
      const el=document.getElementById('labelPreview');
      return await html2canvas(el,{scale:3,backgroundColor:'#ffffff'});
    }

    function unitToPx(val, unit, dpi){
      if(!val || val<=0) return 0;
      if(unit==='px') return val;
      if(unit==='mm') return (val/25.4)*dpi;
      if(unit==='in') return val*dpi;
      return val;
    }

    function getTargetPixels(canvasW, canvasH){
      const wVal = parseFloat(document.getElementById('outW').value);
      const hVal = parseFloat(document.getElementById('outH').value);
      const unit = document.getElementById('outUnit').value || 'mm';
      const dpi = parseFloat(document.getElementById('outDPI').value)||300;
      const keep = document.getElementById('keepAR').checked;
      const ar = canvasW / canvasH;

      let W = unitToPx(wVal, unit, dpi);
      let H = unitToPx(hVal, unit, dpi);

      if(keep){
        if(W>0 && (!H || H<=0)){
          H = W / ar;
        }else if(H>0 && (!W || W<=0)){
          W = H * ar;
        }else if(W>0 && H>0){
          H = W / ar;
        }
      }
      if((!W || W<=0) && (!H || H<=0)){
        W = canvasW; H = canvasH;
      }else if(!W || W<=0){
        W = H*ar;
      }else if(!H || H<=0){
        H = W/ar;
      }
      return {W:Math.max(1,Math.round(W)), H:Math.max(1,Math.round(H)), dpi};
    }

    function fillFromCurrent(){
      const el = document.getElementById('labelPreview');
      const r = el.getBoundingClientRect();
      const wmm = (r.width/96)*25.4;
      const hmm = (r.height/96)*25.4;
      document.getElementById('outW').value = wmm.toFixed(1);
      document.getElementById('outH').value = hmm.toFixed(1);
      document.getElementById('outUnit').value = 'mm';
    }

    async function downloadImage(type){
      const srcCanvas = await toCanvas();
      const srcW = srcCanvas.width, srcH = srcCanvas.height;
      const target = getTargetPixels(srcW, srcH);
      const {W, H} = target;

      const out = document.createElement('canvas');
      out.width = W; out.height = H;
      const ctx = out.getContext('2d');
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'high';
      ctx.drawImage(srcCanvas, 0, 0, srcW, srcH, 0, 0, W, H);

      const mime = type==='jpg' ? 'image/jpeg' : 'image/png';
      const data = out.toDataURL(mime, 1.0);
      const a=document.createElement('a');
      a.href=data; a.download=`supplement-label.${type}`; a.click();
    }

    async function downloadPDF(){
      const srcCanvas = await toCanvas();
      const srcW = srcCanvas.width, srcH = srcCanvas.height;
      const { jsPDF } = window.jspdf || {};
      if(!jsPDF){
        alert('jsPDF not loaded. PDF export requires the CDN. Try hard-refresh or disable blockers.');
        throw new Error('jsPDF missing');
      }

      const wVal = parseFloat(document.getElementById('outW').value);
      const hVal = parseFloat(document.getElementById('outH').value);
      const unit = document.getElementById('outUnit').value || 'mm';
      const dpi = parseFloat(document.getElementById('outDPI').value)||300;
      const keep = document.getElementById('keepAR').checked;

      const ar = srcW/srcH;
      function toMm(val){
        if(!val || val<=0) return 0;
        if(unit==='mm') return val;
        if(unit==='in') return val*25.4;
        if(unit==='px') return (val/dpi)*25.4;
        return 0;
      }
      let wmm = toMm(wVal);
      let hmm = toMm(hVal);
      if(keep){
        if(wmm>0 && (!hmm || hmm<=0)){
          hmm = wmm / ar;
        }else if(hmm>0 && (!wmm || wmm<=0)){
          wmm = hmm * ar;
        }else if(wmm>0 && hmm>0){
          hmm = wmm / ar;
        }
      }
      if((!wmm || wmm<=0) && (!hmm || hmm<=0)){
        wmm = (srcW/96)*25.4/3; // scale=3 capture
        hmm = (srcH/96)*25.4/3;
      }else if(!wmm || wmm<=0){
        wmm = hmm*ar;
      }else if(!hmm || hmm<=0){
        hmm = wmm/ar;
      }

      const pdf = new jsPDF({orientation: (wmm>hmm?'landscape':'portrait'), unit:'mm', format:'a4'});
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();
      const margin = 10;
      let drawW = wmm, drawH = hmm;
      const maxW = pageW - 2*margin, maxH = pageH - 2*margin;
      const scale = Math.min(maxW/drawW, maxH/drawH, 1);
      drawW *= scale; drawH *= scale;
      const x = (pageW - drawW)/2, y=(pageH - drawH)/2;

      // resample for sharp print
      const targetPxW = Math.max(1, Math.round((drawW/25.4) * dpi));
      const targetPxH = Math.max(1, Math.round((drawH/25.4) * dpi));
      const resampled = document.createElement('canvas');
      resampled.width = targetPxW; resampled.height = targetPxH;
      const rctx = resampled.getContext('2d');
      rctx.imageSmoothingEnabled = true;
      rctx.imageSmoothingQuality = 'high';
      rctx.drawImage(srcCanvas, 0, 0, srcW, srcH, 0, 0, targetPxW, targetPxH);
      const imgData = resampled.toDataURL('image/png');

      pdf.addImage(imgData, 'PNG', x, y, drawW, drawH);
      pdf.save('supplement-label.pdf');
    }

    // Live input binding + CDN check
    function bindLiveInputs(){
      const ids = ['servingSize','servingsPerContainer','otherIngredients','additionalFootnotes'];
      ids.forEach(id=>{
        const el = document.getElementById(id);
        if(el){
          el.addEventListener('input', updateLabel);
          el.addEventListener('change', updateLabel);
        }
      });
    }
    function checkCDNs(){
      const ok1 = typeof html2canvas !== 'undefined';
      const ok2 = window.jspdf && typeof window.jspdf.jsPDF === 'function';
      if(!ok1 || !ok2){
        const msg = [
          !ok1 ? '‚Ä¢ html2canvas failed to load (PNG/JPG export disabled)' : '',
          !ok2 ? '‚Ä¢ jsPDF failed to load (PDF export disabled)' : ''
        ].filter(Boolean).join('\\n');
        alert('Some exporter libraries did not load from CDN.\\n' + msg + '\\n\\nTry a hard refresh (Ctrl/Cmd+Shift+R). If you use an ad/script blocker, allow jsDelivr.');
      }
    }
    document.addEventListener('DOMContentLoaded', ()=>{
      bindLiveInputs();
      updateLabel();
      updateMmInfo();
      checkCDNs();
    });
  </script>
</body>
</html>